script.
    var g_curEditScriptRouteIndex = -1;

    $(document).ready(function() 
    { 
        jQuery.fn.extend({ 
            center:function(width,height) 
            {
                return $(this).css("left", ($(window).width()-width)/2+$(window).scrollLeft()). 
                    css("top", ($(window).height()-height)/2+$(window).scrollTop()). 
                    css("width",width). 
                    css("height",height); 
            } 
        }); 
    }); 
    //===========================点击展开关闭效果====================================  
    function openShutManager(oSourceObj, oTargetObj, shutAble, oOpenTip, oShutTip) {
        var sourceObj = typeof oSourceObj == "string" ? $(oSourceObj)[0] : oSourceObj;
        var targetObj = typeof oTargetObj == "string" ? $(oTargetObj)[0] : oTargetObj;

        var openTip = oOpenTip || "";
        var shutTip = oShutTip || "";
        if (targetObj.style.display != "none") {
            if (shutAble) return;
            targetObj.style.display = "none";
            if (openTip && shutTip) {
                sourceObj.innerHTML = shutTip;
            }
        } else {
            targetObj.style.display = "block";
            if (openTip && shutTip) {
                sourceObj.innerHTML = openTip;
            }
        }
    }

    function getTag(i, j) {
        return i + '_' + j;
    }
    // 弹出调用的方法
    function showDivFun(){
        $('div#proto').show();
    }
    // 关闭事件
    function closeDivFun(){
        $('div#proto').hide();
    }

    // 弹出调用的方法
    function showScriptWindow(){
        $('div#script').show();
    }
    // 关闭事件
    function closeScriptWindow(){
        $('div#script').hide();
    }

    function showConsoleWindow() {
        $('div#console').show();
    }

    function closeConsoleWindow() {
        $('div#console').hide();
    }


    function onAddProto() {
        showDivFun();
    }

    function onAddTemplate() {
        var selectedText = $('select.template').find("option:selected").text();
        socket.emit('AddTemplate', {jobName: selectedText});
    }

    function onModify(i, j) {
        var param = 'table#param' + getTag(i, j);
        var paramEdit = 'table#paramEdit' + getTag(i, j);
        var paramVar = 'table#paramVar' + getTag(i, j);
        $(paramEdit).show();
        $(param).hide();
        $(paramVar).hide();
    }

    function onSaveParam(i, j, paramName) {
        var param = 'table#param' + getTag(i, j);
        var paramEdit = 'table#paramEdit' + getTag(i, j);
        var paramVar = 'table#paramVar' + getTag(i, j);
        var input = 'input#param' + getTag(i, j);

        

        socket.emit('SetC2SParamValue', {routeIndex: i, paramName: paramName, value:$(input).val(), isVar: false});

        //- $(paramEdit).hide();
        //- $(param).show();
        //- $(paramVar).hide();
    }

    function onSwitchToVariant(i, j) {
        var param = 'table#param' + getTag(i, j);
        var paramEdit = 'table#paramEdit' + getTag(i, j);
        var paramVar = 'table#paramVar' + getTag(i, j);
        $(paramEdit).hide();
        $(param).hide();
        $(paramVar).show();
    }

    function onSaveVarParam(i, j, paramName) {
        var param = 'table#param' + getTag(i, j);
        var paramEdit = 'table#paramEdit' + getTag(i, j);
        var paramVar = 'table#paramVar' + getTag(i, j);
        var select = 'select#param' + getTag(i, j);

        var selectedText = $(select).find("option:selected").text();
        var idx = selectedText.indexOf('#');
        if (idx > -1) {
            selectedText = selectedText.slice(0, idx);
        }
        socket.emit('SetC2SParamValue', {routeIndex: i, paramName: paramName, value:selectedText, isVar: true});

        //- $(paramEdit).hide();
        //- $(param).show();
        //- $(paramVar).hide();
    }

    function onShowScript(i) {
        g_curEditScriptRouteIndex = i;

        showScriptWindow();
        socket.emit('GetScript', {routeIndex: i});

        $('code.codeArea').html('loading....');
    }

    // 变量指令-----------------------------------------------

    function getTag2(i) {
        return i;
    }

    function onCreateVariable(i) {
        var paramCreate = 'table#varParamCreate' + getTag2(i);
        var paramEdit = 'table#varParamEdit' + getTag2(i);

        $(paramEdit).show();
        $(paramCreate).hide();
    }

    function onCancelCreateVariable(i) {
        var paramCreate = 'table#varParamCreate' + getTag2(i);
        var paramEdit = 'table#varParamEdit' + getTag2(i);

        $(paramEdit).hide();
        $(paramCreate).show();
    }

    function onSaveVariable(i) {
        var input = 'input#varParamText' + getTag2(i);
        var inputDesc = 'input#varParamTextDesc' + getTag2(i);
        socket.emit('createVariable', {routeIndex: i, varName: $(input).val(), varDesc: $(inputDesc).val()});
    }

    function onModifyVariable(i) {
        var param = 'table#varParam' + getTag2(i);
        var paramEdit2 = 'table#varParamEdit2' + getTag2(i);

        var input = 'input#varParamText' + getTag2(i);
        var inputDesc = 'input#varParamTextDesc' + getTag2(i);

        $(param).hide();
        $(paramEdit2).show();
    }

    function onDeleteVariable(i) {
        socket.emit('setBindVariable', {routeIndex: i, varName: null, varDesc: null});
    }


    function onModifyVariableOk(i) {
        var input2 = 'input#varParamText2' + getTag2(i);
        var inputDesc2 = 'input#varParamTextDesc2' + getTag2(i);
        socket.emit('setBindVariable', {routeIndex: i, varName: $(input2).val(), varDesc: $(inputDesc2).val()});
    }

    function onCancelModifyVariable(i) {
        var paramEdit2 = 'table#varParamEdit2' + getTag2(i);
        var varParam = 'table#varParam' + getTag2(i);

        $(paramEdit2).hide();
        $(varParam).show();
    }
    // 变量指令-----------------------------------------------

    socket.on('DispatchScript', function(data) {
        onCancelScriptClicked();
        if (data.codeHTML) {
            $('code.codeArea').html(data.codeHTML);
        }
        else {
            $('code.codeArea').html('没有脚本');
        }
    });

    function onEditScriptClicked() {
        $('a.scriptEdit').hide();
        $('a.scriptSave').show();
        $('a.scriptCancel').show();
        $('#codeViewArea').hide();
        $('#codeEditorArea').show();
        $('textarea.script').text($('code.codeArea').text());
    }

    function onSaveScriptClicked() {
        socket.emit('SaveScript', {routeIndex: g_curEditScriptRouteIndex, code: $('textarea.script').val()});
    }

    socket.on('SaveScriptAck', function(data) {
        if (data.ret == 0) {
            onShowScript(g_curEditScriptRouteIndex);
        }
        else{
            alert('保存脚本失败');
        }
    });

    function onCancelScriptClicked() {
        $('a.scriptEdit').show();
        $('a.scriptSave').hide();
        $('a.scriptCancel').hide();
        $('#codeViewArea').show();
        $('#codeEditorArea').hide(); 
    }

    function onRemoveProto(routeIndex) {
        socket.emit('RemoveProto', {routeIndex: routeIndex});
    }

    function onDeleteScriptClicked() {
       socket.emit('SaveScript', {routeIndex: g_curEditScriptRouteIndex, code: null});
    }

    function onRunClicked() {
        socket.emit('Run');
        showConsoleWindow();
    }

    function onUpClicked(index) {
        if (confirm("调整协议顺序会导致被调整的协议参数丢失，确定吗？"))
        {
            socket.emit('MoveProtoUp', {routeIndex: index});
        }
    }

    function onDownClicked(index) {
        if (confirm("调整协议顺序会导致被调整的协议参数丢失，确定吗？"))
        {
            socket.emit('MoveProtoDown', {routeIndex: index});
        }
    }

    socket.on('Console', function(data){
        var ta = $('textarea.console');
        ta.text(ta.val() + '\r\n' + data.text);

        ta.scrollTop(ta[0].scrollHeight);

        console.log(data.text);
    });

mixin c2sParamList(c2sParam)
    table(border='1' align='left')
        - if (c2sParam.length == 0)
            tr
                td 无
        - else
            - for (var j = 0; j < c2sParam.length; ++j)
                - var tag = i + '_' + j;
                tr
                    td(align='center') 参数#{j+1}
                    td(align='center') #{c2sParam[j].name}
                    td(align='center') #{c2sParam[j].type}
                    td(align='center') 
                        table(id='param' + tag, border='1')
                            tr
                                td(id='value' + tag) #{c2sParam[j].value}
                                td
                                    a(href='javascript:void(0)', onclick='onModify(' + i + ',' + j + ')') 修改
                        table(id='paramEdit' + tag, border='1', style='display:none')
                            tr
                                td
                                    input(id='param' + tag, type='text' value=c2sParam[j].value)
                                td
                                    a(href='javascript:void(0)', onclick='onSaveParam(' + i + ',' + j + ",'" + c2sParam[j].name + "')") 保存
                                td
                                    a(href='javascript:void(0)', onclick='onSwitchToVariant(' + i + ',' + j + ')') 变量
                        table(id='paramVar' + tag, border='1', style='display:none')
                            tr
                                td
                                    select(id='param' + tag)
                                        - for (var k = 0; k < i; ++k)
                                            - if (Object.keys(jobDetail.instruments[k].bindVariable).length > 0) 
                                                option= jobDetail.instruments[k].bindVariable.name + '#' + jobDetail.instruments[k].bindVariable.desc
                                td
                                    a(href='javascript:void(0)', onclick='onSaveVarParam(' + i + ',' + j + ",'" + c2sParam[j].name + "')") 保存
                                    
                    td(align='center') #{c2sParam[j].isVar}

mixin s2cParamList(s2cParam)
    table(border='1' align='left')
        - if (s2cParam.length == 0)
            tr
                td 无
        - else
            - for (var j = 0; j < s2cParam.length; ++j)
                tr
                    td(align='center') 参数#{j+1}
                    td(align='center') #{s2cParam[j].name}
                    td(align='center') #{s2cParam[j].type}

mixin createVariable(bindVariable)
    table(border='0' align='left')
        - if (!bindVariable || !bindVariable.name)
            - var tag = i;
            tr
                    td(align='center')
                        table(id='varParamCreate' + tag, border='0')
                            tr
                                td
                                    a(href='javascript:void(0)', onclick='onCreateVariable(' + i + ')') 创建变量
                        table(id='varParamEdit' + tag, border='1', style='display:none')
                            tr                       
                                td(align='center') 
                                    table(border='1' align='center')
                                        tr
                                            td(align='center') 变量名称
                                            td 
                                                input(id='varParamText' + tag, type='text' value='')
                                            td(align='center') 变量描述
                                            td
                                                input(id='varParamTextDesc' + tag, type='text' value='')
                                        tr
                                            td
                                            td(align='center')
                                                a(href='javascript:void(0)', onclick='onSaveVariable(' + i + ')') 保存
                                            td
                                            td(align='center')
                                                a(href='javascript:void(0)', onclick='onCancelCreateVariable(' + i + ')') 取消
        - else
            - var tag = i;
            tr
                    td(align='center')
                        table(id='varParam' + tag, border='1')
                            tr
                                td(align='center') 
                                    table(border='1' align='center')
                                        tr
                                            td(align='center') 变量名称
                                            td(align='center') #{bindVariable.name}
                                        tr
                                            td(align='center') 变量描述
                                            td(align='center') #{bindVariable.desc}
                                        tr
                                            td
                                                a(href='javascript:void(0)', onclick='onModifyVariable(' + i + ')') 修改
                                            td
                                                a(href='javascript:void(0)', onclick='onDeleteVariable(' + i + ')') 删除
                        table(id='varParamEdit2' + tag, border='1', style='display:none')
                            tr                       
                                td(align='center') 
                                    table(id='varParamCreate' + tag, border='1')
                                   
                                        tr
                                            td(align='center') 变量名称
                                            td 
                                                input(id='varParamText2' + tag, type='text' value=bindVariable.name)
                                        
                                            td(align='center') 变量描述
                                            td
                                                input(id='varParamTextDesc2' + tag, type='text' value=bindVariable.desc)
                                    
                                            tr
                                                td
                                                td 
                                                    a(href='javascript:void(0)', onclick='onModifyVariableOk(' + i + ')') 修改
                                                td
                                                td
                                                    a(href='javascript:void(0)', onclick='onCancelModifyVariable(' + i + ')') 取消
                                                


div
    //- if selectedJobName
    //-     h1 #{selectedJobName}
    div.protocolPopupWindowDiv#proto(style="display : none")
        a(href="javascript:closeDivFun()" style="right : 14; position : absolute;") 关闭窗口
        div.protocolPopupDiv(onclick="closeDivFun()")
            span.protocolSpan x

        div(style="width : 100%; height : 95%; top : 20; position : absolute; overflow : auto")
            include protocolList
            script.
                // g_event is defined in protocolList
                g_event.bind('protoList_routeclicked', function(data) {
                    socket.emit('AddProto', data);
                    closeDivFun();
                });


    div.protocolPopupWindowDiv#script(style="display : none")
        a.scriptEdit(href="javascript:void(0)", style='float:left', onclick='onEditScriptClicked()') 编辑
        a.scriptDelete(href="javascript:void(0)", style='float:left', onclick='onDeleteScriptClicked()') 删除
        a.scriptSave(href="javascript:void(0)", style='float:left;display:none', onclick='onSaveScriptClicked()') 保存
        a.scriptCancel(href="javascript:void(0)", style='display:none', onclick='onCancelScriptClicked()') 取消
        a(href="javascript:closeScriptWindow()" style="right : 14; position : absolute;") 关闭窗口
        div.protocolPopupDiv(onclick="closeScriptWindow()")
            span.protocolSpan x

        div(style="width : 100%; height : 95%; top : 20; position : absolute; overflow : auto")
            #codeViewArea
                pre
                    code.codeArea
            #codeEditorArea(style='display:none')
                textarea.script(style='resize:none;width:100%;height:100%')


    div.protocolPopupWindowDiv#console(style="display : none")
        a(href="javascript:closeConsoleWindow()" style="right : 14; position : absolute;") 关闭窗口
        div.protocolPopupDiv(onclick="closeConsoleWindow()")
            span.protocolSpan x

        div(style="width : 100%; height : 95%; top : 20; position : absolute; overflow : auto")
            #consoleViewArea
                textarea.console(style='resize:none;width:100%;height:100%', readonly="readonly")

    if jobDetail
        h2 #{jobDetail.jobName}
        //- p
        //-     a(href='javascript:void(0)', onclick='openShutManager(this, "table#current", false, "点击合上", "点击展开")') 点击合上
        table#current(border='5')
            tr
                td(align='center') 操作
                td(align='center') 协议路由
                td(align='center') 协议说明
                td(align='center') 协议类型
                td(align='center') 参数
                td
            - for (var i = 0; i < jobDetail.instruments.length; ++i)
                tr
                    td(align='center')
                        table
                            tr
                                td
                                    button(onclick='onUpClicked(' + i + ')') 上
                                    button(onclick='onDownClicked(' + i + ')') 下
                                td
                                    a(href='javascript:void(0)', onclick='onRemoveProto(' + i + ')') 删除
                    td(align='center') #{jobDetail.instruments[i].route}
                    td(align='center') #{jobDetail.instruments[i].note}
                    td(align='center') #{jobDetail.instruments[i].type}
                    td(align='center')
                        table(border='3' align='left')
                            tr
                                td(align='center') 上行参数
                                td(align='center')
                                    +c2sParamList(jobDetail.instruments[i].c2s)
                            tr
                                td(align='center') 下行参数
                                td(align='center')
                                    +s2cParamList(jobDetail.instruments[i].s2c)
                            tr
                            - if (jobDetail.instruments[i].type == 5) {
                                td(align='center') 定义变量
                                td(align='center')
                                    +createVariable(jobDetail.instruments[i].bindVariable)
                            - }
                                    

                    td(align='center')
                        if jobDetail.instruments[i].hasScript
                            a(href='javascript:void(0)', onclick='onShowScript(' + i + ')') 编辑脚本
                        else
                            a(href='javascript:void(0)', onclick='onShowScript(' + i + ')') 新建脚本


        a(href='javascript:void(0)', onclick='onAddProto()') 添加协议
        //- br
        //- select.template
        //-     - for (var i = 0; i < jobList.length; ++i)
        //-         option #{jobList[i].name}
        //- a(href='javascript:void(0)', onclick='onAddTemplate()') 添加模板

    br
    br
    a(href='javascript:void(0)', onclick='onRunClicked()') 运行
    br
    a(href='javascript:void(0)', onclick='showConsoleWindow()') 控制台
